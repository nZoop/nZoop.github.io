<html>
  <head>
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"
      integrity="sha256-4iQZ6BVL4qNKlQ27TExEhBN1HFPvAvAMbFavKKosSWQ="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"
      integrity="sha256-R4pqcOYV8lt7snxMQO/HSbVCFRPMdrhAFMH+vr9giYI="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div width="95%">
      <canvas id="cChart"></canvas>
    </div>
    <script>
      console.log(navigator.language)
      console.log(navigator.languages)
      const labels = {
        en: {
          chart: 'Spread of COVID-19 in Finland',
          bars: 'New infections per day [bars]',
          line: 'Total number of infected [line]',
          iLine: 'confirmed infections',
          tLine: 'projected infections',
          pLine: ['epidemic contained within', 'weeks from first infection'],
        },
        fi: {
          chart: 'Koronaviruksen levinneisyys suomessa',
          bars: 'Päivittäiset tartunnat [pylväät]',
          line: 'Tartunnansaaneiden kokonaismäärä [viiva]',
          iLine: 'varmistetut tartunnat',
          tLine: 'ennustetut tartunnat',
          pLine: [
            'epidemia taittuu',
            'viikon sisällä ensimmäisistä tartunnoista',
          ],
        },
      }[navigator.language.slice(0, 2)]

      const infectionLineDataset = {
        data: [{ t: moment(), y: 0 }],
        legend: {
          text: labels.iLine,
          fillStyle: 'rgba(230, 90, 20, 0.5)',
          strokeStyle: 'rgb(230, 90, 20)',
          lineJoin: 'round',
        },
        order: 1,
        type: 'line',
        fill: false,
        borderColor: 'rgb(230, 90, 20)',
        pointRadius: 0,
        xAxisID: 'time-axis-0',
        yAxisID: 'log-axis',
      }
      const infectionBarDataset = {
        data: [{ t: moment(), y: 0 }],
        type: 'bar',
        order: 10,
        backgroundColor: 'rgba(230, 90, 20, 0.5)',
        barPercentage: 0.4,
        xAxisID: 'time-axis-0',
        yAxisID: 'linear-axis',
      }
      const trendlineDataset = {
        data: [{ t: moment(), y: 0 }],
        legend: {
          text: labels.tLine,
          fillStyle: 'rgba(240, 180, 40, 0.4)',
          strokeStyle: 'rgb(240, 180, 40)',
          lineDash: [8, 4],
          lineJoin: 'round',
        },
        type: 'line',
        order: 2,
        fill: false,
        borderColor: 'rgb(240, 180, 40)',
        borderDash: [10, 5],
        pointRadius: 0,
        xAxisID: 'time-axis-0',
        yAxisID: 'log-axis',
      }
      const trendbarDataset = {
        data: [{ t: moment(), y: 0 }],
        type: 'bar',
        order: 11,
        backgroundColor: 'rgba(240, 180, 40, 0.4)',
        barPercentage: 0.6,
        xAxisID: 'time-axis-0',
        yAxisID: 'linear-axis',
      }

      const predictionLineDataset = week => ({
        data: [{ t: moment(), y: 0 }],
        legend: {
          text: `${labels.pLine[0]} ${week} ${labels.pLine[1]}`,
          fillStyle: `rgba(${140 + week * 15}, ${100 + week * 20}, ${160 +
            week * 10}, 0.6)`,
          strokeStyle: `rgb(${140 + week * 15}, ${100 + week * 20}, ${160 +
            week * 10})`,
          lineDash: [8, 4],
          lineJoin: 'round',
        },
        type: 'line',
        order: week,
        fill: false,
        borderColor: `rgb(${140 + week * 15}, ${100 + week * 20}, ${160 +
          week * 10})`,
        borderDash: [10, 5],
        pointRadius: 0,
        xAxisID: 'time-axis-0',
        yAxisID: 'log-axis',
        cutoffWeek: week,
      })
      const predictionLineDatasets = [
        predictionLineDataset(3),
        predictionLineDataset(4),
        predictionLineDataset(5),
        predictionLineDataset(6),
      ]
      const predictionBarDataset = week => ({
        data: [{ t: moment(), y: 0 }],
        type: 'bar',
        order: 10 + week,
        backgroundColor: `rgba(${140 + week * 15}, ${100 + week * 20}, ${160 +
          week * 10}, 0.6)`,
        barPercentage: 0.65 + 0.05 * week,
        xAxisID: `time-axis-${week}`,
        yAxisID: 'linear-axis',
        cutoffWeek: week,
      })
      const predictionBarDatasets = [
        predictionBarDataset(3),
        predictionBarDataset(4),
        predictionBarDataset(5),
        predictionBarDataset(6),
      ]
      const createTimeAxis = (axis, display, min, max) => ({
        id: `time-axis-${axis}`,
        type: 'time',
        time: {
          tick: 'day',
          ticks: {
            min: min,
            max: max,
          },
        },
        display: display,
        stacked: true,
        gridLines: {
          offsetGridLines: true,
        },
      })

      const cChart = new Chart('cChart', {
        type: 'bar',
        data: {
          datasets: [
            infectionLineDataset,
            infectionBarDataset,
            trendlineDataset,
            trendbarDataset,
            predictionLineDatasets[0],
            predictionLineDatasets[1],
            predictionLineDatasets[2],
            predictionLineDatasets[3],
            predictionBarDatasets[0],
            predictionBarDatasets[1],
            predictionBarDatasets[2],
            predictionBarDatasets[3],
          ],
        },
        options: {
          title: {
            text: labels.chart,
            display: true,
          },
          legend: {
            position: 'bottom',
            labels: {
              generateLabels: ({ config }) =>
                config.data.datasets
                  .filter(dataset => 'legend' in dataset)
                  .map(dataset => dataset.legend),
            },
          },
          scales: {
            xAxes: [
              createTimeAxis(0, true, moment(), moment().add(1, 'months')),
              createTimeAxis(3, false, moment(), moment().add(1, 'months')),
              createTimeAxis(4, false, moment(), moment().add(1, 'months')),
              createTimeAxis(5, false, moment(), moment().add(1, 'months')),
              createTimeAxis(6, false, moment(), moment().add(1, 'months')),
            ],
            yAxes: [
              {
                id: 'log-axis',
                scaleLabel: {
                  labelString: labels.line,
                  display: true,
                },
                type: 'logarithmic',
                position: 'right',
                ticks: {
                  autoSkip: false,
                  callback: tick => {
                    if (tick / Math.pow(10, Math.floor(Math.log10(tick))) === 1)
                      return tick.toString()
                    return ''
                  },
                  min: 1,
                  max: 6000000,
                },
              },
              {
                id: 'linear-axis',
                stacked: true,
                scaleLabel: {
                  labelString: labels.bars,
                  display: true,
                },
                type: 'linear',
                position: 'left',
                ticks: {
                  callback: tick => {
                    if (tick % 50 === 0) return tick.toString()
                    return ''
                  },

                  min: 0,
                  max: 600 + Math.log10(6) * 100,
                  stepSize: 100,
                  beginAtZero: true,
                },
                stacked: false,
              },
            ],
          },
        },
      })

      $.get(
        'https://w3qa5ydb4l.execute-api.eu-west-1.amazonaws.com/prod/finnishCoronaData',
        data => {
          const makeBars = line =>
            line.map((value, i) => ({
              t: moment(value.t),
              y: i === 0 ? value.y : value.y - line[i - 1].y,
            }))
          let iLine = Array.from(
            data.confirmed
              .slice(1)
              .reduce(
                (cMap, confirmed, i) =>
                  cMap.set(
                    new Date(confirmed.date).setHours(0, 0, 0, 0),
                    i + 1
                  ),
                new Map()
              ),
            ([date, confirmed]) => ({ t: moment(date), y: confirmed })
          ).sort((a, b) => a.t - b.t)
          let iBars = makeBars(iLine)
          let tData = iLine.map(value => ({
            x: value.t.diff(iLine[0].t, 'days'),
            y: Math.log10(value.y),
          }))
          let tSlope =
            (tData.length *
              tData.reduce((sum, data) => sum + data.x * data.y, 0) -
              tData.reduce((sum, data) => sum + data.x, 0) *
                tData.reduce((sum, data) => sum + data.y, 0)) /
            (tData.length *
              tData.reduce((sum, data) => sum + data.x * data.x, 0) -
              Math.pow(
                tData.reduce((sum, data) => sum + data.x, 0),
                2
              ))
          let tOffset =
            (tData.reduce((sum, data) => sum + data.y, 0) -
              tSlope * tData.reduce((sum, data) => sum + data.x, 0)) /
            tData.length
          let tLine = Array.from(
            {
              length: moment()
                .add(2, 'months')
                .diff(iLine[0].t, 'days'),
            },
            (n, i) => ({
              t: moment(iLine[0].t).add(i, 'days'),
              y: Math.floor(Math.pow(10, i * tSlope + tOffset)),
            })
          )
          let tBars = makeBars(tLine)

          infectionLineDataset.data = iLine
          infectionBarDataset.data = iBars
          trendlineDataset.data = tLine
          trendbarDataset.data = tBars

          const predictLine = week =>
            tLine
              .filter(i =>
                i.t.isSameOrAfter(moment(iLine[0].t).add(week, 'weeks'))
              )
              .map((value, i) => ({
                t: moment(value.t),
                y: Math.floor(
                  Math.pow(
                    10,
                    (7 * week +
                      Math.log(
                        value.t.diff(
                          moment(iLine[0].t).add(week, 'weeks'),
                          'days'
                        ) + 1
                      )) *
                      tSlope +
                      tOffset
                  )
                ),
              }))
          predictionLineDatasets.forEach(
            dataset => (dataset.data = predictLine(dataset.cutoffWeek))
          )
          predictionBarDatasets.forEach((dataset, i) => {
            dataset.data = makeBars(predictionLineDatasets[i].data)
            dataset.data[0] = tBars[dataset.cutoffWeek * 7]
          })

          let min = moment(iLine[0].t)
          let max = moment()
            .add(2, 'months')
            .add(-1, 'days')

          cChart.options.scales.xAxes = [
            createTimeAxis(0, true, min, max),
            createTimeAxis(3, false, min, max),
            createTimeAxis(4, false, min, max),
            createTimeAxis(5, false, min, max),
            createTimeAxis(6, false, min, max),
          ]
          cChart.update()
        }
      )
    </script>
  </body>
</html>
